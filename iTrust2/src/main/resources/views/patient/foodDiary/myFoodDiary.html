<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{})">
<title>My Food Diary</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content" class="container" ng-app="diaryApp" ng-controller="diaryCtrl as ctrl">
		
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular-mocks.js"></script>
		
		<!-- javascript stuff -->
		<script th:inline="javascript">
		
			var app = angular.module('diaryApp',['ngMockE2E']);
			
			angular.module('diaryApp').factory('diaryService', ['$http', '$q', '$httpBackend', function( $http, $q, $httpBackend) {
				
				var REST_SERVICE_URI = '/iTrust2/api/v1/patientdiaryentries';
				
				// Initializes data for mock GET request
				self.mockDiaryEntries = [];
				
				for (var i = 0; i < 10; i++) {
					self.mockDiaryEntries.push({
						patientName: "Noah Benveniste",
						date: "10/3/2018",
						mealType: "Lunch",
						name: "bagel",
						servings: i % 3 + 1,
						caloriesPerServing: i * 13 + 100,
						fat: i * 4 + i % 2,
						sodium: i + (i % 2) * 3,
						carbs: i % 3 * 2,
						sugar: i % 2 + 10 + i,
						fiber: i + i % 3,
						protein: i % 4
					});
				}
				
				// Mock interception of REST api calls. Comment this section out to use real API
				$httpBackend.whenRoute('GET', REST_SERVICE_URI)
				   .respond(function(method, url, data, headers, params) {
				   return [200, self.mockDiaryEntries];
				});
				
				$httpBackend.whenRoute('PUT', REST_SERVICE_URI)
					.respond(function(method, url, data, headers, params) {
					let obj = JSON.parse(data);
				    self.mockDiaryEntries.push(obj);
				    
				    // Code to sort the list (Note: this should occur on the backend, this is just for mocking purposes)
				    
				    return [201, mockDiaryEntries];
				});
				// end mock interception
				
				// Services
				var factory = {
					getEntriesService: getEntriesService,
					addEntryService: addEntryService
				};
				
				return factory;
				
				function getEntriesService() {
					var deferred = $q.defer();
					$http.get(REST_SERVICE_URI)
						.then(
						function(response) {
							deferred.resolve(response.data);
						},
						function(errResponse) {
							console.error('Error while getting diary entries (getEntriesService)')
							deferred.reject(errResponse);
						}
					);
					return deferred.promise;
				}
				
				function addEntryService(entry) {
					var deferred = $q.defer();
					$http.put(REST_SERVICE_URI, entry)
						.then(
						function(response) {
							deferred.resolve(response.data);
						},
						function(errResponse) {
							console.error('Error while adding diary entry')
							deferred.reject(errResponse);
						}
					);
					return deferred.promise;
				}

			}]);
			
			angular.module('diaryApp').controller('diaryCtrl', ['$scope', 'diaryService', function( $scope, diaryService ) {
				var self = this;
				
				// TODO: update this data format based on the JSON format of the DiaryEntry.java class when it's finished
				self.diaryEntry = {patientName:'', date:'', mealType:'', name:'', servings:'', caloriesPerServing:'', fat:'', sodium:'', carbs:'', sugar:'', fiber:'', protein:''};
				self.diaryEntryMaster = [];
				
				$scope.mealTypes = ['Breakfast', 'Lunch', 'Dinner', 'Snack'];
				$scope.patientName = '';
				
				self.submit = submit;
				self.reset = reset;
				
				getEntries();
				
				// Calculate nutrient totals
				
				function getEntries() {
					diaryService.getEntriesService()
						.then(
						function(data) {
							
							// Update the master list of diary entries
							self.diaryEntryMaster = data;
							
							// Get the user's name
							$scope.patientName = self.diaryEntryMaster[0].patientName;
						},
						function(errResponse) {
							console.error('Error while getting diary entries (getEntries)');
						}
					);
				}
				
				function addEntry(entry) {
					
					$scope.success = false;
					$scope.failure = false;
					
					diaryService.addEntryService(entry)
						.then(getEntries,
						function(errResponse) {
							$scope.failure = true;
							$scope.success = false;
							console.error('Error while adding diary entry');
						}
					);
					
					$scope.success = !($scope.failure);
					
				}
				
				function submit() {
					addEntry(self.diaryEntry);
					console.log('Diary entry added');
					reset();
				}
				
				function reset() {
					self.diaryEntry = {patientName:'', date:'', mealType:'', name:'', servings:'', caloriesPerServing:'', fat:'', sodium:'', carbs:'', sugar:'', fiber:'', protein:''};
				    $scope.addDiaryEntryForm.$setPristine(); //reset Form
				}
				
			}]);
			
		</script>
		
		<h1>My Food Diary</h1>
		<div th:include="diaryTable :: diaryTable"></div>
		<!-- TODO: input validation for creating a diary entry -->
		<!-- Form for new food diary -->
		<div class="generic-container">
			<div class="panel panel-default">
	
				<!-- Heading -->
				<div class="panel-heading">
					<span class="lead">Add an entry</span>
				</div>
	
				<!-- Entry forms -->
				<div class="panel-body">
					<div class="formcontainer">
						<form ng-submit="ctrl.submitDiaryEntry()" name="addDiaryEntryForm" class="form-horizontal">
	
							<!-- Padding so date field isn't overlapping header -->
							<div class="row">
								<div class="form-group col-md-12"></div>
							</div>
	
							<!-- Form for entering date; TODO: proper form validation -->
							<div class="row">
								<div class="col-sm-2 col-xs-4 control-lable" for="file">
									<label>Date</label>
								</div>
								<div class="col-sm-3 col-xs-8">
									<input type="text" ng-model="ctrl.diaryEntry.date" name="date"
										class="name form-control input-sm"
										placeholder="Enter date (mm/dd/yyyy)" required="0" />
								</div>
							</div><br/>
							<div class="row">
								<div class="col-sm-3 col-xs-2 control-lable" for="file">
									<label>Select meal type</label>
								</div>
								<div class="col-xs-3 col-xs-10">
									<select ng-model="ctrl.diaryEntry.mealType" name="mealType"
										placeholder="Select meal type" required="0">
										<option ng-repeat="m in mealTypes">{{m}}</option>
									</select>
								</div>
							</div><br/>
							<div class="row">
								<div class="col-sm-2 col-xs-3 control-lable" for="file">
									<label>Name of food</label>
								</div>
								<div class="col-sm-4 col-xs-9">
									<input type="text" ng-model="ctrl.diaryEntry.name" name="name"
										class="name form-control input-sm"
										placeholder="Enter name of food" required="0" />
								</div>
							</div>
							<div class="row"><hr/></div>
							<div class="row">
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.servings"
												name="servings" class="name form-control input-sm"
												placeholder="Enter number of servings" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Number of Servings</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text"
												ng-model="ctrl.diaryEntry.caloriesPerServing"
												name="caloriesPerServing" class="name form-control input-sm"
												placeholder="Enter calories per serving" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Calories per serving</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.fat" name="fat"
												class="name form-control input-sm"
												placeholder="Enter fat per serving (g)" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Amount of fat per serving (g)</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.sodium"
												name="sodium" class="name form-control input-sm"
												placeholder="Enter sodium per serving (mg)" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Amount of sodium per serving</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.carbs"
												name="carbs" class="name form-control input-sm"
												placeholder="Enter carbs per serving (mg)" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Amount of carbs per serving (g)</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.sugar"
												name="sugar" class="name form-control input-sm"
												placeholder="Enter sugar per serving (mg)" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Amount of sugar per serving (g)</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.fiber"
												name="fiber" class="name form-control input-sm"
												placeholder="Enter fiber per serving (mg)" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Amount of fiber per serving (g)</label>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="row">
										<div class="col-xs-4">
											<input type="text" ng-model="ctrl.diaryEntry.protein"
												name="protein" class="name form-control input-sm"
												placeholder="Enter protein per serving (mg)" required="0" />
										</div>
										<div class="col-xs-8 control-lable" for="file">
											<label>Amount of protien per serving (g)</label>
										</div>
									</div>
								</div>
							</div>
							<div class="row"><hr/></div>
							<div class="row">
								<div class="form-actions col-md-12">
									<input type="submit" value="Submit"
										class="btn btn-primary btn-sm"
										ng-disabled="addDiaryEntryForm.$invalid" />
									<button type="button" ng-click="ctrl.reset()"
										class="btn btn-warning btn-sm"
										ng-disabled="addDiaryEntryForm.$pristine">Reset Form</button>
								</div>
							</div>
						</form>
					</div>
	
					<div ng-show="success">Diary Entry Added</div>
					<div ng-show="failure">Error while adding diary entry.</div>
				</div>
			</div>
		</div>
		
		<!-- Navigate back to patient landing page -->
		<a href="/iTrust2/patient/index">Patient Home Page</a>
		
	</div>
</body>
</html>